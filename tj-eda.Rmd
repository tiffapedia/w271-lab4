---
title: "W271 Lab 4"
author: "Shan He, Joanna Huang, Tiffany Jaya, Robert Deng"
output: 
  pdf_document:
  toc: true
  number_sections: true
fontsize: 11pt
geometry: margin=1in
---


```{r}
# Load libraries
library(knitr)
library(car)
library(dplyr)
library(Hmisc)
library(ggplot2)
library(lattice)
library(plm)
library(grid)
library(gridExtra)
# prevent source code from running off the page
opts_chunk$set(tidy.opts=list(width.cutoff=70), tidy=TRUE)
# remove all objects from current workspace
rm(list = ls())
# set seed number to reproduce results
set.seed(1)
# load data
load("data/driving.RData")
```

1. Load the data. Provide a description of the basic structure of the dataset, as we have done in throughout the semester. Conduct a very thorough EDA, which should include both graphical and tabular techniques, on the dataset, including both the dependent variable *totfatrte* and the potential explanatory variables. You need to write a detailed narrative of your observations of your EDA. *Reminder: giving an "output dump" (i.e. providing a bunch of graphs and tables without description and hoping your audience will interpret them) will receive zero point in this exercise.*

```{r}
data
```

2. How is the our dependent variable of interest *totfatrte* defined? What is the average of this variable in each of the years in the time period covered in this dataset? Estimate a very simple regression model of totfatrte on dummy variables for the years 1981 through 2004. What does this model explain? Describe what you find in this model. Did driving become safer over this period? Please provide a detailed explanation.

Our dependent variable *totfatrte* is defined as total fatalities per 100,000 population. Its average per year are listed below.

```{r fig.show='hold', fig.align='center', out.width='49%', results='hide'}
totfatrte.avg.per.year <- aggregate(list(totfatrte.avg.per.year=data$totfatrte), by=list(year=data$year), FUN=mean)
knitr::kable(totfatrte.avg.per.year)
plot(totfatrte.avg.per.year)
```

There is a noticeable downward trend with steep declines occuring twice: once from 1980 to 1983 and another one from 1988 to 1992. 

```{r fig.show='hold', fig.align='center', out.width='49%', results='hide'}
dummy.1981.to.2004 <- c(paste('d',  seq(81, 99, by=1), sep=''), 
                        paste('d0', seq(00, 04, by=1), sep=''))
m1 <- lm(data$totfatrte ~ ., data=data[dummy.1981.to.2004])
summary(m1)
plot(m1)
```

With 1980 as the base year, the intercept represents total fatality rate in that year. We can see that the intercept value 25.5 matches that of the average total fatality rate in 1980 (calculated in the first part of this question). In 1981, the estimated total fatality rate is 25.5 - 1.8(1), which equals 23.7 and so forth. Therefore, the fitted regression equation is $\text{totfatrte.avg.per.year} = 25.5 -1.8\cdot d81 -4.6\cdot d82-5.3\cdot d83-5.2\cdot d84-5.6\cdot d85-4.7\cdot d86-4.7\cdot d87-4.6\cdot d88-6.0\cdot d90-7.4\cdot d91-8.3\cdot d92-8.4\cdot d93-8.3\cdot d94-7.8\cdot d95-8.1\cdot d96-7.9\cdot d97-8.2\cdot d98-8.2\cdot d99-8.7\cdot d00-8.7\cdot d01-8.5\cdot d02-8.7\cdot d03-8.8\cdot d04$. In other words, the model explains the average difference in the yearly fatalities as compared to the baseline year of 1980. 

The negative coefficients represent a decrease in average fatality rate each year relative to 1980. Since the coefficients for the year dummy variables (except for 1981) are statistically significant at the 1% significance level, we see strong evidence that drivers become safer over the years. 

3. Expand your model in *Exercise 2* by adding variables *bac08, bac10, perse, sbprim, sbsecon, sl70plus, gdl, perc14_24, unem, vehicmilespc*, and perhaps *transformations of some or all of these variables*. Please explain carefully your rationale, which should be based on your EDA, behind any transformation you made. If no transformation is made, explain why transformation is not needed. How are the variables *bac8* and *bac10* defined? Interpret the coefficients on *bac8* and *bac10*. Do *per se laws* have a negative effect on the fatality rate? What about having a primary seat belt law? (Note that if a law was enacted sometime within a year the fraction of the year is recorded in place of the zero-one indicator.)

```{r}
explanatory_vars <- c('bac08', 'bac10', 'perse', 'sbprim', 
                      'sbsecon', 'sl70plus', 'gdl', 'perc14_24', 
                      'unem', 'vehicmilespc', dummy.1981.to.2004)
m2 <- lm(data$totfatrte ~ ., data=data[explanatory_vars])
summary(m2)
plot(m2)
```

No transformation was needed for the continuous variables since 1) they are normalized and 2) they don't demonstrate obvious non-linear relationship with the dependent variable. 

*bac8* and *bac10* are defined to denote the blood alcohol content allowed by each state, with "bac08" representing 8% and "bac10" representing 10%. They are not strictly binary and the fraction denotes the fraction of time that the policy was imposed, just like the other "binary" variables" for the other traffic laws. 

The coefficient for bac8 is -2.50 and bac10 -1.42. This means that with all other variables held constant, the fatality rate drops by 2.50 if 8% alchohol content is allowed and is enforced 100% of the time. On the other hand, the fatality rate only drops by 1.42 if 10% alchohol content is allowed and is enforced 100% of the time. Both coefficients are statistically significant but the model results suggest that all else held equal, a state with a blood alcohol content allowance of 8% would have a lower $totfatrte$ than a state that has a threshold of 10%.

Per se law seemed to have a significant negative effect on fatality rate at the 5% significance level with a coefficient of -.62. Primary seat belt law, on the other hand, doesn't seem to have a significant impact on the fatality rate with a coefficient of -.08 that is not statistically significant.

4. Reestimate the model from *Exercise 3* using a fixed effects (at the state level) model. How do the coefficients on *bac08, bac10, perse, and sbprim* compare with the pooled OLS estimates? Which set of estimates do you think is more reliable? What assumptions are needed in each of these models?  Are these assumptions reasonable in the current context?


```{r}
traffic.panel <- plm.data(traffic, c("state", "year"))

m3.fe <- plm(totfatrte ~d81 +d82 + d83 + d84 + d85 + d86 + d87 + d88 + d89 + d90 + d91 + d92 + d93 + d94 + d95 + d96 + d97 + d98 + d99 + d00 + d01 + d02 + d03 + d04 + bac08 + bac10 + perse + sbprim + sbsecon + sl70plus + gdl + perc14_24 + unem + vehicmilespc, data=traffic.panel, model = "within")

summary(m3.fe)
```

The coefficients for bac08 and bac10 decreased in size (from -2.5 to -1.4 and from -1.4 to -1.1 respectively) yet those for perse and sbprim became more pronounced (from -.62 to -1.2 and from -.08 to -1.2 respectively). The p-value for perse and sbprim also decreased, implying strong statistical significance (at 99.9% confidence level). 

Pooled OLS regression assumes that the fixed effects and idiosyncratic errors are uncorrelated with any of the explanatory variables. A violation of this assumption leads to heterogeneity bias (or bias caused from omitting a time-constant variable) in the model estimates. In our context, such an assumption does not hold as we are observed the same states multiple times over a period of time. Thus there are bound to be constant state-specific effects, such as road conditions that are not included in the model and can affect our results.

Fixed effects models, on the other hand, allow for persisting influence, such as state economy or perspectives on alcohol, to be correlated with the explanatory variables, and also eliminates such within-state heterogeneity. Therefore, the estimates from this fixed effects model are more reliable since it controls for not just year-level but also state-level unobserved effect. To further test whether this is true, we can use the pFtest.

```{r}
pFtest(m3.fe, m2) # Testing for fixed effects, null: OLS better than fixed
```
Since the p-value is less than .01 and statistically significant at the 1% level, we can reject the null that the pooled OLS regression is a better model than the fixed model. 


5. Suppose that *vehicmilespc*, the number of miles driven per capita, increases by 1,000. Using the FE estimates, what is the estimated effect on totfatrte? Please interpret the estimate as if explaining to a layperson.

Since the coefficient is 0.000940, an increase by 1,000 indicates that, with all other variables held constant, the fatality rate will go up by 0.94. In simple English, with all other variables being the same, a 1000 miles increase in the number of miles driven per captia will increase the fatality rate by 0.94. 

6. If there is serial correlation or heteroskedasticity in the idiosyncratic errors of the model, what would be the consequences on the coefficient estimates and their standard errors?
